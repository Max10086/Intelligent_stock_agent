# History Sync: Server-Side Batch Reports to Client History

## Problem

Users could not see reports generated by **Batch Analysis (Background Worker)** in the `HistorySidebar`:
- `HistorySidebar` was reading only from `localStorage` or client-side state
- Batch reports were saved in Server Database (`AnalysisJob.result` field)
- No connection between Server DB and Client History state

## Solution

Implemented server-side history API and synchronized it with client-side history management.

## Implementation

### 1. Server-Side History API (`server/routes/history.ts`)

Created REST API endpoints for history management:

#### `GET /api/history`
- Fetches all completed analysis jobs with results
- Returns `AnalysisState[]` compatible with frontend
- Sorted by completion date (most recent first)

**Response:**
```json
{
  "history": [
    {
      "id": "job-id",
      "query": "AAPL",
      "timestamp": "2024-01-18T10:00:00Z",
      "status": "complete",
      "language": "en",
      "focusCompany": {...},
      "candidateCompanies": [...]
    }
  ],
  "total": 10
}
```

#### `DELETE /api/history/:id`
- Deletes a specific report from history
- Deletes the `AnalysisJob` record (which contains the result)

#### `DELETE /api/history`
- Clears all history
- Deletes all completed `AnalysisJob` records

### 2. Updated Server Index (`server/index.ts`)

Added history router:
```typescript
import { historyRouter } from './routes/history.js';
app.use('/api/history', historyRouter);
```

### 3. Updated Client History Hook (`hooks/useStockAgent.ts`)

#### Server History Fetching
- Added `useEffect` hook that fetches server history on component mount
- Merges server history with localStorage history
- Deduplicates by ID (server entries take precedence)
- Sorts by timestamp (most recent first)

#### Delete History
- Updated `deleteFromHistory()` to be async
- Deletes from server first, then from local state
- Handles errors gracefully (continues with local deletion if server fails)

#### Clear History
- Updated `clearHistory()` to be async
- Clears from server first, then from local state
- Handles errors gracefully

## Data Flow

### History Loading Flow

```
Component Mount
  ↓
Load localStorage history (immediate)
  ↓
Fetch server history (async)
  ↓
Merge histories (deduplicate by ID)
  ↓
Sort by timestamp
  ↓
Update state
```

### History Deletion Flow

```
User clicks delete
  ↓
DELETE /api/history/:id (server)
  ↓
Update local state (remove from array)
  ↓
Save to localStorage
```

## Merging Strategy

1. **Initial Load**: Start with localStorage history (fast, immediate)
2. **Server Sync**: Fetch server history and merge
3. **Deduplication**: Use Map with ID as key
   - Server entries take precedence (newer/more authoritative)
   - Local entries kept if not in server
4. **Sorting**: Sort merged array by timestamp (descending)

## Benefits

1. **Unified History**: Both single-run and batch-run reports appear in sidebar
2. **Persistent Storage**: Batch reports persist across browser sessions
3. **Backward Compatible**: Existing localStorage history still works
4. **Graceful Degradation**: Works even if server is unavailable
5. **Real-time Sync**: History updates when batch jobs complete

## API Endpoints

### GET /api/history
- **Purpose**: Fetch user's report history
- **Response**: `{ history: AnalysisState[], total: number }`
- **Auth**: None (can add later if needed)

### DELETE /api/history/:id
- **Purpose**: Delete a specific report
- **Response**: `{ success: boolean, message: string, deletedId: string }`
- **Errors**: 404 if report not found

### DELETE /api/history
- **Purpose**: Clear all history
- **Response**: `{ success: boolean, message: string, deletedCount: number }`

## Testing

To test the history sync:

1. **Submit Batch Job**:
   - Go to Batch Queue page
   - Submit multiple tickers (e.g., "AAPL MSFT TSLA")
   - Wait for jobs to complete

2. **Check History Sidebar**:
   - Open history sidebar
   - Verify batch reports appear
   - Check timestamps are correct

3. **Test Deletion**:
   - Delete a batch report from history
   - Verify it disappears from sidebar
   - Refresh page - should stay deleted

4. **Test Clear All**:
   - Clear all history
   - Verify all reports disappear
   - Refresh page - should stay cleared

## Future Enhancements

1. **Pagination**: Add pagination for large history lists
2. **Filtering**: Filter by date range, ticker, etc.
3. **Search**: Search history by ticker or query
4. **Export**: Export history to CSV/JSON
5. **User Authentication**: Add user-specific history (if multi-user)

## Migration Notes

- No database migration needed (uses existing `AnalysisJob.result` field)
- Backward compatible with existing localStorage history
- Existing single-run reports continue to work as before
- Batch reports automatically appear after implementation
